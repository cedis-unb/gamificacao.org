# Fix Multi-Domain Redirects (November 3, 2025)

## Problem

All redirect pages (root and pagination) were being generated by Hugo with absolute URL redirects:

```html
<!-- Root redirect -->
<meta http-equiv="refresh" content="0; url=https://gamificacao.org/pt/">

<!-- Pagination redirects -->
<meta http-equiv="refresh" content="0; url=https://gamificacao.org/en/playground/">
```

This broke multi-domain support because the site would always redirect to `gamificacao.org` instead of working correctly on `gamification.cedis.cloud`.

## Solution

Implemented a post-build script that:

1. **Hugo generates** all redirects with absolute URLs (standard behavior)
2. **Post-build script** (`scripts/fix-root-redirect.js`) replaces all redirects with relative URLs
3. **Root page** uses JavaScript redirect that detects browser language
4. **Pagination pages** use relative path redirects (e.g., `../../../../en/playground/`)

### Key Changes

#### `package.json`
```json
"build": "HUGO_CACHEDIR=\"$(pwd)/newSite/.hugo_cache\" hugo -s newSite -D --gc && node scripts/fix-root-redirect.js"
```

#### `scripts/fix-root-redirect.js` (NEW)
- Runs automatically after Hugo build
- Fixes root `docs/index.html` with browser language detection
- Converts all 49+ pagination redirects to use relative paths
- No external dependencies (uses only Node.js fs and path)

#### `newSite/layouts/index.html` (MODIFIED)
- Replaced with JavaScript-based redirect (now unused by build, but kept as documentation)
- Root page generated by script instead

### Result

#### Root Redirect (before):
```html
<meta http-equiv="refresh" content="0; url=https://gamificacao.org/pt/">
```

#### Root Redirect (after):
```html
<script>
  // Detect browser language and redirect to relative path
  const lang = navigator.language || navigator.userLanguage;
  const targetPath = lang.startsWith('en') ? '/en/' : '/pt/';
  window.location.href = targetPath;
</script>
```

#### Pagination Redirects (before):
```html
<meta http-equiv="refresh" content="0; url=https://gamificacao.org/en/playground/">
```

#### Pagination Redirects (after):
```html
<meta http-equiv="refresh" content="0; url=../../../../en/playground/">
```

## How Multi-Domain Works Now

The relative URLs allow the site to work on any domain:

- `https://gamificacao.org/` → `/en/` or `/pt/` → `https://gamificacao.org/en/` or `https://gamificacao.org/pt/`
- `https://gamification.cedis.cloud/` → `/en/` or `/pt/` → `https://gamification.cedis.cloud/en/` or `https://gamification.cedis.cloud/pt/`
- `https://example.com/` → `/en/` or `/pt/` → `https://example.com/en/` or `https://example.com/pt/`

All redirects work correctly without any hardcoded domain!

## Deployment

Both domains now work correctly:
```bash
npm run build
# Output: ✓ Fixed root index.html redirect
#         ✓ Fixed 49 pagination redirects
#         ✓ All redirects converted to relative URLs
```

## Build Stats

- Pages generated: 75 PT + 71 EN = 146 pages
- Pagination redirects fixed: 49
- Total redirects converted: 50 (1 root + 49 pagination)
