{{/* People rendering sourced from people2.yaml (gamification only) plus optional extras */}}
{{- $lang := .Page.Lang | default .Site.Language.Lang -}}

{{/* 1) Extras: researchers/collaborators from people_extras.yaml, or fallback to legacy people.yaml */}}
{{- $extras := site.Data.people_extras -}}
{{- if $extras -}}
  {{- range $group := $extras.groups -}}
    {{- $title := index $group.title $lang | default (index $group.title "en") -}}
    {{- with $title -}}<h2 class="mt-8 mb-4 text-2xl font-bold">{{ . | markdownify }}</h2>{{- end -}}
    {{- partial "people/card_list.html" (dict "items" $group.items "lang" $lang) -}}
  {{- end -}}
{{- else if site.Data.people -}}
  {{- $allowed := (slice "researchers" "collaborators") -}}
  {{- range $group := site.Data.people.groups -}}
    {{- if in $allowed $group.key -}}
      {{- $title := index $group.title $lang | default (index $group.title "en") -}}
      {{- with $title -}}<h2 class="mt-8 mb-4 text-2xl font-bold">{{ . | markdownify }}</h2>{{- end -}}
      {{- partial "people/card_list.html" (dict "items" $group.items "lang" $lang) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* 2) Gamification-only from people2.yaml, grouped by category */}}
{{- $p2data := (index site.Data "people-cedis") | default dict -}}
{{- $p2 := $p2data.people | default (slice) -}}
{{- $gamers := where $p2 "tags" "intersect" (slice "gamification") -}}

{{- /* Build group slices */ -}}
{{- $masters := where $gamers "categories" "intersect" (slice "master_student") -}}
{{- $si := where $gamers "categories" "intersect" (slice "scientific_initiation") -}}
{{- $tcc := where $gamers "categories" "intersect" (slice "tcc") -}}

{{- /* Build existing names set for dedup */ -}}
{{- $.Scratch.Set "names" (slice) -}}
{{- range $gamers -}}{{- $.Scratch.Add "names" (slice .name) -}}{{- end -}}
{{- $names := ($.Scratch.Get "names") -}}

{{- /* Infer additional concluded people from productions-cedis (gamification + type) */ -}}
{{- $proddata := (index site.Data "productions-cedis") | default dict -}}
{{- $proditems := $proddata | default slice -}}
{{- if $proddata.items -}}{{- $proditems = $proddata.items -}}{{- end -}}
{{- $prodgam := where ($proditems | default (slice)) "tags" "intersect" (slice "gamification") -}}
{{- $.Scratch.Set "inf_masters" (slice) -}}
{{- $.Scratch.Set "inf_tcc" (slice) -}}
{{- range $p := $prodgam -}}
  {{- $ptype := lower ($p.type | default "") -}}
  {{- $cat := "" -}}
  {{- if eq $ptype "dissertation" -}}
    {{- $cat = "master_student" -}}
  {{- else if eq $ptype "tcc" -}}
    {{- $cat = "tcc" -}}
  {{- else -}}
    {{- /* skip other types */ -}}
  {{- end -}}
  {{- if $cat -}}
    {{- with $p.authors -}}
      {{- range . -}}
        {{- $author := . -}}
        {{- if and $author (not (in $names $author)) -}}
          {{- $dict := dict "name" $author "categories" (slice $cat) "tags" (slice "inactive") -}}
          {{- with $p.advisors -}}{{- $dict = merge $dict (dict "advisors" .) -}}{{- end -}}
          {{- if eq $cat "master_student" -}}
            {{- $.Scratch.Add "inf_masters" (slice $dict) -}}
          {{- else if eq $cat "tcc" -}}
            {{- $.Scratch.Add "inf_tcc" (slice $dict) -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $inf_masters := ($.Scratch.Get "inf_masters") -}}
{{- $inf_tcc := ($.Scratch.Get "inf_tcc") -}}

{{- /* Combine base + inferred lists per group */ -}}
{{- $.Scratch.Set "masters_all" (slice) -}}
{{- range $x := $masters -}}{{- $.Scratch.Add "masters_all" (slice $x) -}}{{- end -}}
{{- range $x := $inf_masters -}}{{- $.Scratch.Add "masters_all" (slice $x) -}}{{- end -}}
{{- $masters_all := ($.Scratch.Get "masters_all") -}}

{{- $.Scratch.Set "tcc_all" (slice) -}}
{{- range $x := $tcc -}}{{- $.Scratch.Add "tcc_all" (slice $x) -}}{{- end -}}
{{- range $x := $inf_tcc -}}{{- $.Scratch.Add "tcc_all" (slice $x) -}}{{- end -}}
{{- $tcc_all := ($.Scratch.Get "tcc_all") -}}

{{- $groups := slice
  (dict "key" "masters" "title" (cond (eq $lang "pt") "Mestrado" "Master's") "items" $masters_all)
  (dict "key" "si" "title" (cond (eq $lang "pt") "Iniciação científica" "Scientific Initiation") "items" $si)
  (dict "key" "tcc" "title" (cond (eq $lang "pt") "TCC" "Undergraduate Thesis") "items" $tcc_all)
-}}

{{- range $g := $groups -}}
  {{- if gt (len $g.items) 0 -}}
    <h2 class="mt-8 mb-4 text-2xl font-bold">{{ $g.title }}</h2>
    {{- /* Build items list with badges (category + status) and sort (active->inactive, then name) */ -}}
    {{- $.Scratch.Set "items" (slice) -}}
    {{- $over := site.Data.people_overrides | default dict -}}
    {{- $advmap := site.Data.people_advisors | default dict -}}
    {{- range $it := $g.items -}}
      {{- $cat := index (intersect $it.categories (slice "master_student" "scientific_initiation" "tcc")) 0 -}}
      {{- $catBadge := "" -}}
      {{- if eq $cat "master_student" -}}
        {{- $catBadge = (cond (eq $lang "pt") "Mestrado" "Master's") -}}
      {{- else if eq $cat "scientific_initiation" -}}
        {{- $catBadge = (cond (eq $lang "pt") "Iniciação científica" "Scientific Initiation") -}}
      {{- else if eq $cat "tcc" -}}
        {{- $catBadge = (cond (eq $lang "pt") "TCC" "Undergraduate Thesis") -}}
      {{- end -}}
      {{- $badges := (slice $catBadge) -}}
      {{- $isInactive := (gt (len (intersect $it.tags (slice "inactive"))) 0) -}}
      {{- if $isInactive -}}
        {{- $statusBadge := (cond (eq $lang "pt") "Concluído" "Completed") -}}
        {{- $badges = ( $badges | append $statusBadge ) -}}
      {{- end -}}
      {{- $o := (index $over $it.name) -}}
      {{- $url := "" -}}
      {{- $avatar := "" -}}
      {{- with $o -}}
        {{- $url = .url | default "" -}}
        {{- $avatar = .avatar | default "" -}}
      {{- end -}}
      {{- /* Resolve advisors to full names via data/people_advisors.yaml; ignore unknown codes */ -}}
      {{- $.Scratch.Set "adv" (slice) -}}
      {{- with $it.advisors -}}
        {{- range . -}}
          {{- $code := . -}}
          {{- $aname := (index $advmap $code) | default "" -}}
          {{- if $aname -}}
            {{- $.Scratch.Add "adv" (slice $aname) -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
      {{- $advisors := ($.Scratch.Get "adv") -}}
      {{- /* Collect productions for inactive people (from productions-cedis, gamification only) */ -}}
      {{- $.Scratch.Set "plist" (slice) -}}
      {{- if $isInactive -}}
        {{- $pp := where $prodgam "authors" "intersect" (slice $it.name) -}}
        {{- range $p := $pp -}}
          {{- $ptitle := $p.title -}}
          {{- if reflect.IsMap $ptitle -}}
            {{- $ptitle = (index $p.title $lang) | default (index $p.title "en") | default (index $p.title "pt") | default "" -}}
          {{- end -}}
          {{- $purl := $p.url | default "" -}}
          {{- $pdoi := $p.doi_isbn | default "" -}}
          {{- $pyear := $p.year | default "" -}}
          {{- $ptype := lower ($p.type | default "") -}}
          {{- $.Scratch.Add "plist" (slice (dict "title" $ptitle "url" $purl "doi" $pdoi "year" $pyear "type" $ptype)) -}}
        {{- end -}}
      {{- end -}}
      {{- $productions := ($.Scratch.Get "plist") -}}
      {{- $.Scratch.Add "items" (slice (dict "name" $it.name "badges" $badges "url" $url "avatar" $avatar "inactive" $isInactive "sortName" (lower $it.name) "advisors" $advisors "productions" $productions)) -}}
    {{- end -}}
    {{- $all := ($.Scratch.Get "items") -}}
    {{- $act := where $all "inactive" false -}}
    {{- $ina := where $all "inactive" true -}}
    {{- $act = (sort $act "sortName") -}}
    {{- $ina = (sort $ina "sortName") -}}
    {{- $.Scratch.Set "final" (slice) -}}
    {{- range $x := $act -}}{{- $.Scratch.Add "final" (slice $x) -}}{{- end -}}
    {{- range $x := $ina -}}{{- $.Scratch.Add "final" (slice $x) -}}{{- end -}}
    {{- partial "people/card_list.html" (dict "items" ($.Scratch.Get "final") "lang" $lang) -}}
  {{- end -}}
{{- end -}}
