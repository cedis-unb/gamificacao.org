{{- $lang := .Page.Lang | default .Site.Language.Lang -}}
{{- $data := site.Data.meetings -}}
{{- $items := (cond $data (index $data $lang) slice) -}}
{{- if (not $items) }}{{ $items = slice }}{{ end -}}
{{- if (eq (len $items) 0) -}}
  {{- /* Fallback: legacy front matter list */ -}}
  {{- $items = .Page.Params.meetings -}}
{{- end -}}
{{- if not $items -}}
  {{- /* No meetings defined */ -}}
  <p class="text-neutral-500">{{ if eq .Page.Lang "pt" }}Nenhuma reunião cadastrada.{{ else }}No meetings yet.{{ end }}</p>
{{- else -}}
  {{- /* Determine next upcoming date (first future date in ascending order) */ -}}
  {{- $now := now -}}
  {{- $asc := sort $items "date" "asc" -}}
  {{- $nextDate := "" -}}
  {{- range $asc -}}
    {{- $d := time .date -}}
    {{- if and (eq $nextDate "") (ge $d $now) -}}
      {{- $nextDate = .date -}}
    {{- end -}}
  {{- end -}}

  {{- /* Collect unique years */ -}}
  {{- $years := slice -}}
  {{- range $items -}}
    {{- $y := (printf "%d" (time .date).Year) -}}
    {{- $years = $years | append $y -}}
  {{- end -}}
  {{- $years = uniq $years -}}
  {{- $years = sort $years "value" "desc" -}}

  <style>
    /* Scoped styles for summary blocks in meetings */
    .summary-block summary::-webkit-details-marker { display: none; }
    .summary-block .summary-content {
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: opacity .25s ease, max-height .35s ease;
    }
    .summary-block[open] .summary-content {
      opacity: 1;
      max-height: 100vh;
    }
    .summary-block .chev { transition: transform .25s ease; }
    .summary-block[open] .chev { transform: rotate(180deg); }
  </style>

  <div class="flex flex-wrap gap-2 mb-6">
    <button data-filter-year="all" class="px-3 py-1 rounded-full text-sm bg-neutral-200 hover:bg-neutral-300 dark:bg-neutral-700 dark:hover:bg-neutral-600">
      {{ if eq .Page.Lang "pt" }}Todos{{ else }}All{{ end }}
    </button>
    {{- range $years -}}
      <button data-filter-year="{{ . }}" class="px-3 py-1 rounded-full text-sm bg-neutral-200 hover:bg-neutral-300 dark:bg-neutral-700 dark:hover:bg-neutral-600">{{ . }}</button>
    {{- end -}}
  </div>

  <ol class="border-l-2 border-primary-500 dark:border-primary-300 list-none pl-6 md:pl-8">
    {{- /* Render in reverse-chronological order */ -}}
    {{- $desc := sort $items "date" "desc" -}}
    {{- range $desc -}}
      {{- $d := time .date -}}
      {{- $year := printf "%d" $d.Year -}}
      <li data-year="{{ $year }}">
        <div class="flex flex-start">
          <div class="bg-primary-500 dark:bg-primary-300 text-neutral-50 dark:text-neutral-700 w-8 h-8 text-2xl flex items-center justify-center rounded-full -ml-10 md:-ml-12 mt-5">
            {{- $icon := resources.Get (printf "icons/%s.svg" (.icon | default "list")) -}}
            {{- if $icon -}}
              <span class="relative inline-block align-text-bottom icon">{{ $icon.Content | safeHTML }}</span>
            {{- end -}}
          </div>
          <div class="block p-6 rounded-lg shadow-2xl w-full sm:w-11/12 md:w-10/12 lg:w-9/12 xl:w-8/12 2xl:w-7/12 ml-6 mb-10 break-words">
            <div class="flex justify-between items-start gap-2 flex-wrap">
              {{- $d := time .date -}}
              {{- $dateStr := (cond (eq $.Page.Lang "pt") ($d.Format "02/01/2006") ($d.Format "Jan 2, 2006")) -}}
              <h2 class="mt-0">
                {{ $dateStr }} · {{ .title }}
              </h2>
              <div class="flex gap-2 items-center">
                {{- if .badge -}}
                <span class="inline-flex items-center rounded-full bg-primary-100 text-primary-700 dark:bg-primary-900/30 dark:text-primary-300 px-2 py-0.5 text-xs">{{ .badge }}</span>
                {{- end -}}
                {{- if eq .date $nextDate -}}
                <span class="px-2 py-0.5 rounded-full text-xs bg-amber-100 text-amber-800 dark:bg-amber-300 dark:text-neutral-900">
                  {{ if eq $.Page.Lang "pt" }}Próximo{{ else }}Next{{ end }}
                </span>
                {{- end -}}
                {{- with .videoURL -}}
                {{- $v := . -}}
                {{ if ne (len $v) 0 }}
                <a href="{{ $v }}" target="_blank" rel="noopener" class="inline-flex items-center gap-1 rounded-full bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300 px-2 py-0.5 text-xs hover:bg-red-200 dark:hover:bg-red-800/40">
                  <span class="inline-block align-text-bottom">{{ partial "icon.html" "play" }}</span>
                  <span>{{ if eq $.Page.Lang "pt" }}Assistir vídeo{{ else }}Watch video{{ end }}</span>
                </a>
                {{ else }}
                <span class="inline-flex items-center rounded-full bg-neutral-200 text-neutral-700 dark:bg-neutral-700 dark:text-neutral-200 px-2 py-0.5 text-xs opacity-80">
                  {{ if eq $.Page.Lang "pt" }}Vídeo em breve{{ else }}Video soon{{ end }}
                </span>
                {{ end }}
                {{- else -}}
                <span class="inline-flex items-center rounded-full bg-neutral-200 text-neutral-700 dark:bg-neutral-700 dark:text-neutral-200 px-2 py-0.5 text-xs opacity-80">
                  {{ if eq $.Page.Lang "pt" }}Vídeo em breve{{ else }}Video soon{{ end }}
                </span>
                {{- end -}}
              </div>
            </div>
            {{- if .speaker -}}
            <h4 class="mt-0">{{ .speaker }}</h4>
            {{- end -}}
            {{- if .desc -}}
            <div class="mb-4">{{ .desc }}</div>
            {{- end -}}
            {{- $item := . -}}
            {{- with .summary -}}
            <details class="mt-1 summary-block">
              <summary class="cursor-pointer select-none text-sm font-medium flex items-center justify-between rounded-md px-3 py-2 bg-neutral-100 dark:bg-neutral-800/60 hover:bg-neutral-200 dark:hover:bg-neutral-700 border border-neutral-200 dark:border-neutral-700">
                <span class="text-primary-700 dark:text-primary-300">{{ if eq $.Page.Lang "pt" }}Resumo{{ else }}Summary{{ end }}</span>
                <span class="chev inline-flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" width="14" height="14" fill="currentColor" class="text-neutral-500">
                    <path d="M143 352.3L7 216.3C-2.3 207-2.3 191 7 181.7s24.3-9.4 33.6 0L160 301.1l119.4-119.4c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9L177 352.3c-9.4 9.4-24.6 9.4-34 0z"/>
                  </svg>
                </span>
              </summary>
              <div class="summary-content mt-2 p-0">
                <div class="flex flex-col lg:flex-row gap-6 pl-4 pr-4 py-4 rounded-md border bg-neutral-50 dark:bg-neutral-800/50 border-neutral-200 dark:border-neutral-700">
                  <div class="basis-auto lg:basis-4/5 grow prose prose-neutral dark:prose-invert max-w-none text-base">
                    {{ . | markdownify }}
                  </div>
                  <aside class="basis-auto lg:basis-1/5 shrink-0 ml-auto lg:pl-2">
                    <div class="rounded-md border border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/50 p-3">
                      <div class="text-sm font-medium mb-3 text-neutral-700 dark:text-neutral-200">{{ if eq $.Page.Lang "pt" }}Recursos{{ else }}Resources{{ end }}</div>
                      {{- $turl := $item.transcriptURL | default "" -}}
                      {{- $links := $item.links | default (slice) -}}
                      {{- $hasTranscript := ne (len $turl) 0 -}}
                      {{- $hasLinks := gt (len $links) 0 -}}
                      {{- if or $hasTranscript $hasLinks -}}
                      <ul class="space-y-2">
                        {{- if $hasTranscript -}}
                        <li>
                          <a href="{{ $turl }}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 text-sm text-primary-700 hover:text-primary-800 dark:text-primary-300 dark:hover:text-primary-200">
                            <span class="inline-block align-text-bottom">{{ partial "icon.html" "file-lines" }}</span>
                            <span>{{ if eq $.Page.Lang "pt" }}Transcrição{{ else }}Transcript{{ end }}</span>
                          </a>
                        </li>
                        {{- end -}}
                        {{- range $links }}
                          {{- $u := .url | default "" -}}
                          <li>
                            {{- if ne (len $u) 0 -}}
                            <a href="{{ $u }}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 text-sm text-primary-700 hover:text-primary-800 dark:text-primary-300 dark:hover:text-primary-200">
                              <span class="inline-block align-text-bottom">{{ partial "icon.html" "link" }}</span>
                              <span>{{ .label }}</span>
                            </a>
                            {{- else -}}
                            <span class="inline-flex items-center gap-2 text-sm opacity-70 cursor-not-allowed">
                              <span class="inline-block align-text-bottom">{{ partial "icon.html" "link" }}</span>
                              <span>{{ .label }}</span>
                            </span>
                            {{- end -}}
                          </li>
                        {{- end }}
                      </ul>
                      {{- end -}}
                    </div>
                  </aside>
                </div>
              </div>
            </details>
            {{- end -}}
          </div>
        </div>
      </li>
    {{- end -}}
  </ol>

  <script>
  (function(){
    var btns = document.querySelectorAll('[data-filter-year]');
    var items = document.querySelectorAll('li[data-year]');
    btns.forEach(function(btn){
      btn.addEventListener('click', function(){
        var y = this.getAttribute('data-filter-year');
        items.forEach(function(li){
          if (y === 'all' || li.getAttribute('data-year') === y) {
            li.classList.remove('hidden');
          } else {
            li.classList.add('hidden');
          }
        });
        btns.forEach(function(b){ b.classList.remove('ring-2','ring-primary-500'); });
        this.classList.add('ring-2','ring-primary-500');
      });
    });
  })();
  </script>
{{- end -}}
